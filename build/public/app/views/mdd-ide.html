<html>
<div style="width:80%;margin-left:auto;margin-right:auto;margin-top:40px">
    <h2 style="font-weight:700">MDD IDE</h2>
    <div id="ide-status" style="position:fixed;top:75px;right:30px"></div>
    <div id="editor-status" style="position:fixed;top:100px;right:30px"></div>
    <div style="position:fixed;left:40%;top:40%;display:block;text-align:center" id="connection-msg">
        Attempting to connect to local IDE server...
        <br>
        <br>
        Make sure you are running /devtools/mdeideserver.js
    </div>
    <div id="ide" style="margin-top:30px;border-top:1px solid gray;display:none">
        <div style="display:flex">
            <div>
                <h4>Select which file to process:</h4>
                <select id="select-file" style="width:300px;height:30px;color:#000"></select>
            </div>
            <div>
                <h4>Select which page:</h4>
                <select id="select-page" style="width:300px;height:30px;color:#000"></select>
            </div>
        </div>
        <div style="display:flex;width:100%;display:none;margin-top:10px;height:calc(100vh - 310px)" id="editor">
            <div id="code-container" style="width:50%;border:none;outline:0;height:100%;overflow:visible">
                <iframe frameborder="0" src="./assets/html/code-editor.html" style="width:100%;height:100%;overflow:visible" id="code-frame"></iframe>
            </div>
            <div style="width:49%;margin-left:1%;height:100%;overflow-y:auto;overflow-x:hidden">
                <div style="display:flex">
                    <input placeholder="Page Title" id="page-title" style="width:90%;background-color:transparent;font-size:30px;width:100%;color:#fff;outline:0;border:none;font-weight:700">
                    <svg onclick="deletePage()" title="Delete Page" style="width:18px;cursor:pointer" viewBox="0 0 24 24" focusable="false" class="chakra-icon css-onkibi">
                        <path fill="red" d="M.439,21.44a1.5,1.5,0,0,0,2.122,2.121L11.823,14.3a.25.25,0,0,1,.354,0l9.262,9.263a1.5,1.5,0,1,0,2.122-2.121L14.3,12.177a.25.25,0,0,1,0-.354l9.263-9.262A1.5,1.5,0,0,0,21.439.44L12.177,9.7a.25.25,0,0,1-.354,0L2.561.44A1.5,1.5,0,0,0,.439,2.561L9.7,11.823a.25.25,0,0,1,0,.354Z"></path>
                    </svg>
                </div>
                <div id="output" class="mdd-render"></div>
            </div>
            <div style="position:fixed;bottom:20px;right:110px;color:#fff;font-size:large;cursor:pointer;background-color:#00f;border-radius:5px;padding:10px 20px" onclick="insertPage()">Insert page after this page</div>
            <div style="position:fixed;bottom:20px;right:20px;color:#fff;font-size:large;cursor:pointer;background-color:green;border-radius:5px;padding:10px 20px" onclick="save()">Save</div>

        </div>
    </div>
</div>

</html>

<script>const codeEditorHelper=require("./utils/codeEditor.js"),renderMdd=require("./utils/renderMdd.js");async function connect(){try{if(setIdeStatus("Connecting...","orange"),200!==(await fetch("http://localhost:2248/status",{headers:{"tApp-Ignore-Cache":"Ignore-Cache"}})).status)return setIdeStatus("Not Connected!","red");setIdeStatus("Connected","green");let e=await fetch("http://localhost:2248/available-files",{headers:{"tApp-Ignore-Cache":"Ignore-Cache"}}),n=(e=await e.json(),[]);delete e.actions,Object.entries(e).forEach(([t,e])=>{e.weeks.forEach(e=>{n.push(t+"/"+e)})}),document.getElementById("select-file").innerHTML=n.map(e=>`<option style="color: black" value="${e}">${e}</option>`);var t=document.createEvent("HTMLEvents");t.initEvent("change",!1,!0),document.getElementById("select-file").value="webdev/HTML",document.getElementById("select-file").dispatchEvent(t)}catch(e){setIdeStatus("Not Connected!","red")}}async function deletePage(){confirm("Are you sure you want to delete this page?")&&(window.currentFile.pages.splice(currentPageNumber,1),currentPageNumber=null,setTimeout(()=>{window.currentPageNumber=0,reloadEditor()},10),await save())}async function insertPage(){let e=window.currentPageNumber+1;window.currentFile.pages.splice(window.currentPageNumber+1,0,{type:"information",title:"Insert title here",elements:[]}),currentPageNumber=null,setTimeout(()=>{window.currentPageNumber=e,reloadEditor()},10),await save()}function sleep(n){return new Promise((e,t)=>{setTimeout(e,n)})}function setIdeStatus(e,t){document.getElementById("ide-status").innerText=e,document.getElementById("ide-status").style.color=t,window.idestate=e,"Connected"===idestate&&(document.getElementById("connection-msg").style.display="none",document.getElementById("ide").style.display="block")}function setEditorStatus(e,t){document.getElementById("editor-status").innerText=e,document.getElementById("editor-status").style.color=t,window.idestate=e}function reloadEditor(){var e=window.currentFile.pages[currentPageNumber].mdd||"No MDD version of this page yet! Get started by deleting this line and re-integrating.";codeEditorHelper.updateContent(e),document.getElementById("page-title").value=window.currentFile.pages[currentPageNumber].title,rerender()}function rerender(){var e=codeEditorHelper.getValue();window.currentFile.pages[currentPageNumber].mdd=e,document.getElementById("output").innerHTML=renderMdd(e)}async function save(){if(window.currentFilePath){currentPageNumber;null!==currentPageNumber&&(window.currentFile.pages[currentPageNumber].title=document.getElementById("page-title").value);let t=[],e=(window.currentFile=JSON.parse(JSON.stringify(window.currentFile).replace(/http:\/\/localhost:2248\/img\/tmp-file-.{40}/gm,function(e){return t.push(e.replace("http://localhost:2248/img/tmp-file-","")),`./data/modules/mdd-assets/${e.replace("http://localhost:2248/img/tmp-file-","")}.png`})),setEditorStatus("Uploading code...","orange"),await fetch("http://localhost:2248/upload?file="+window.currentFilePath,{method:"PUT",headers:{"Content-Type":"application/json","tApp-Ignore-Cache":"Ignore-Cache"},body:JSON.stringify(window.currentFile)}));await e.text(),setEditorStatus("Uploading images...","orange"),await Promise.all(t.map(async e=>{await fetch("http://localhost:2248/save-tmp-image/"+e,{method:"PUT"})})),setEditorStatus("Ready","green")}}window.idestate="Connecting...",window.monacostate="loading",window.currentFile={},window.currentFilePath="",window.currentPageNumber=0,connect(),document.getElementById("select-file").addEventListener("change",async function(t){setEditorStatus("Download file...","orange");let e=await fetch("http://localhost:2248/available-files",{headers:{"tApp-Ignore-Cache":"Ignore-Cache"}}),n=(e=await e.json(),await fetch("http://localhost:2248/download?file="+t.target.value.split("/")[0]+"/"+e[t.target.value.split("/")[0]].weeks.findIndex(e=>e===t.target.value.split("/")[1]),{headers:{"tApp-Ignore-Cache":"Ignore-Cache"}}));currentFile=await n.json(),currentFilePath=t.target.value.split("/")[0]+"/"+e[t.target.value.split("/")[0]].weeks.findIndex(e=>e===t.target.value.split("/")[1]),document.getElementById("select-page").innerHTML=currentFile.pages.map((e,t)=>`<option style="color: black" ${"information"!==e.type?"disabled":""} value="${t}">${t}${"information"!==e.type?"-not an editable page ":""}</option>`),window.currentPageNumber=0,document.getElementById("editor").style.display="flex",setEditorStatus("Ready","green"),reloadEditor()}),document.getElementById("select-page").addEventListener("change",async function(e){window.currentPageNumber=e.target.value,reloadEditor()}),setEditorStatus("Loading...","orange"),document.getElementById("code-frame").contentWindow.addEventListener("message",e=>{"monacoloaded"===e.data.message&&(setEditorStatus(window.monacostate="Ready","green"),codeEditorHelper.updateLanguage("markdown"),codeEditorHelper.updateContent("Loading..."),document.getElementById("code-frame").contentWindow.listeners.onChange=rerender)}),document.getElementById("code-frame").contentWindow.addEventListener("paste",function(e){var t=(e.clipboardData||e.originalEvent.clipboardData).items;for(index in t){var n,a=t[index];"file"===a.kind&&(a=a.getAsFile(),(n=new FileReader).onload=async function(e){console.log(e.target.result),setEditorStatus("Uploading image...","orange");e=await(await fetch("http://localhost:2248/upload-tmp-image",{method:"POST",body:JSON.stringify({data:e.target.result}),headers:{"Content-Type":"application/json"}})).text();console.log(e),document.getElementById("code-frame").contentWindow.codeEditor.trigger("keyboard","type",{text:`![Image_Description](${e})`}),setEditorStatus("Ready","green")},n.readAsDataURL(a))}})</script>