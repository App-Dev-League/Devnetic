"use strict";var Module,Perl={trace:!1,endAfterMain:!1,noMountIdbfs:!1,WebPerlVersion:"v0.09-beta",state:"Uninitialized",exitStatus:void 0,Util:{},initStepsLeft:2,readyCallback:null,stdout_buf:"",stderr_buf:"",dispatch:function(e){if(Perl._call_code_args=Array.prototype.slice.call(arguments,1),Perl.eval(e),Perl._call_code_error)throw e=Perl._call_code_error,delete Perl._call_code_error,e;return e=Perl._call_code_rv,delete Perl._call_code_rv,e},startScriptScan:function(){var t,n=[];if(document.querySelectorAll("script[type='text/perl']").forEach(function(e){e.src?t||n.length?console.error('Only a single Perl script may be loaded via "script src=", ignoring others'):t=e.src:t?console.error('Only a single Perl script may be loaded via "script src=", ignoring others'):n.push(e.innerHTML)}),t){console.debug("Perl: Found a script with src, fetching and running...",t);var e=new XMLHttpRequest;e.addEventListener("load",function(){Perl._saveAndRun(this.responseText)}),e.open("GET",t),e.send()}else if(n.length){console.debug("Perl: Found",n.length,"embedded script(s), autorunning...");for(var r=n.join(";\n"),l=6,i=-1;l--&&i++<r.length&&!((i=r.indexOf("\n",i))<0););e=i<0?r:r.substring(0,i);const a=/^\s*use\s+WebPerl(\s|;)/m;a.exec(e)||(console.debug("Perl: Autoloading WebPerl"),r="use WebPerl 'js';\n"+r),Perl._saveAndRun(r)}else console.debug("Perl: No embedded scripts")},_saveAndRun:function(e){Perl.init(function(){var t="/tmp/scripts.pl";try{FS.writeFile(t,e),console.debug("Perl: Saved script(s) to ",t,", now running"),window.addEventListener("beforeunload",function(){console.debug("Perl: beforeunload, ending..."),Perl.end()}),window.setTimeout(function(){Perl.start([t])},1)}catch(e){console.error("Perl:",e),alert("Save to "+t+" failed: "+e)}})},changeState:function(e){if(Perl.state!=e){var t=Perl.state;Perl.state=e,Perl.stateChanged&&(console.info("Perl.stateChanged is deprecated, please use Perl.addStateChangeListener instead"),Perl.stateChanged(t,e));for(var n=0;n<Perl.stateChangeListeners.length;n++)Perl.stateChangeListeners[n](t,e)}},stateChangeListeners:[function(e,t){console.debug("Perl: state changed from "+e+" to "+t)}],addStateChangeListener:function(e){Perl.stateChangeListeners.push(e)},output:function(e,t){for(var n=2==t?"stderr_buf":"stdout_buf",r=(Perl[n]+=e,Perl[n].indexOf("\n"));-1<r;)console.log(2==t?"STDERR":"STDOUT",Perl[n].slice(0,r)),Perl[n]=Perl[n].slice(r+1),r=Perl[n].indexOf("\n")},outputLine:function(e,t){2<arguments.length&&(t=Array.prototype.slice.call(arguments,1).join(" ")),Perl.output(t,e),Perl.output("\n",e)},outputChar:function(e,t){Perl.output(String.fromCharCode(t),e)},makeOutputTextarea:function(e){var t=document.createElement("textarea");return e&&(t.id=e),t.rows=24,t.cols=80,t.setAttribute("readonly",!0),Perl.output=function(e){t.value=t.value+e,t.scrollTop=t.scrollHeight},t}},getScriptURL=function(){var e=document.getElementsByTagName("script");return e[e.length-1],function(){return window.location.origin+window.location.pathname.replace("index.html","")}}();Perl.Util.baseurl=function(e){return"file:"==(e=new URL(e)).protocol?e.href.substring(0,e.href.lastIndexOf("/")):e.origin+e.pathname.substring(0,e.pathname.lastIndexOf("/"))},Perl.init=function(e){if("Uninitialized"!=Perl.state)throw"Perl: can't call init in state "+Perl.state;Perl.changeState("Initializing");var t=Perl.Util.baseurl(getScriptURL());Perl.readyCallback=e,Module={noInitialRun:!0,noExitRuntime:!0,print:Perl.outputLine.bind(null,1),printErr:Perl.outputLine.bind(null,2),stdout:Perl.outputChar.bind(null,1),stderr:Perl.outputChar.bind(null,2),stdin:function(){return null},arguments:["--version"],onAbort:function(){console.error("Perl: Aborted (state",Perl.state,")"),alert("Perl aborted in state "+Perl.state),Perl.exitStatus=-1,Perl.changeState("Ended")},onExit:function(e){0==e?console.debug("Perl: Exit status",e,"(state",Perl.state,")"):(console.error("Perl: Exit status",e,"(state",Perl.state,")"),alert("Perl exited with exit status "+e+" in state "+Perl.state)),Perl.exitStatus=e,Perl.changeState("Ended")},onRuntimeInitialized:function(){console.debug("Perl: Module.onRuntimeInitialized"),Perl.initStepFinished()},preRun:[function(){if(Perl.noMountIdbfs)return console.debug("Perl: doing preRun, skipping IndexDB filesystem"),void Perl.initStepFinished();console.debug("Perl: doing preRun, fetching IndexDB filesystem...");try{FS.mkdir("/mnt")}catch(e){}try{FS.mkdir("/mnt/idb")}catch(e){}FS.mount(IDBFS,{},"/mnt/idb"),FS.syncfs(!0,function(e){if(e)return console.error("Perl:",e),void alert("Perl: Loading IDBFS failed: "+e);console.debug("Perl: IndexDB filesystem ready"),Perl.initStepFinished()})}],locateFile:function(e){return/\.(wast|wasm|asm\.js|data)$/.exec(e)?t+"/"+e:e}},Perl.endAfterMain&&Module.preRun.push(function(){var e=Module._main;Module._main=function(){return e.apply(this,arguments),console.debug("Perl: main() has ended, ending perl..."),Perl.end()}}),console.debug("Perl: Fetching Emscripten/Perl..."),(e=document.createElement("script")).async=!0,e.defer=!0,e.src=t+"/emperl.js",document.getElementsByTagName("head")[0].appendChild(e)},Perl.initStepFinished=function(){if("Initializing"!=Perl.state||Perl.initStepsLeft<1)throw"Perl: internal error: can't call initStepFinished in state "+Perl.state+" ("+Perl.initStepsLeft+")";var n;--Perl.initStepsLeft?console.debug("Perl: One init step done, but "+Perl.initStepsLeft+" steps left, waiting..."):(console.debug("Perl: All init steps done, doing final initialization..."),n=Module.quit,Module.quit=function(e,t){console.debug("Perl: quit with",t),Module.onExit(e),n(e,t)},Perl.changeState("Ready"),Perl.readyCallback&&Perl.readyCallback(),Perl.readyCallback=null)},Perl.start=function(e){if("Ready"!=Perl.state)throw"Perl: can't call start in state "+Perl.state;Perl.changeState("Running");try{Module.callMain(e||Module.arguments)}catch(e){if(!(e instanceof ExitStatus))throw e;console.debug("Perl: start:",e),Module.onExit(e.status)}},Perl.eval=function(e){if("Running"!=Perl.state)throw"Perl: can't call eval in state "+Perl.state;Perl.trace&&console.debug("Perl: ccall webperl_eval_perl",e);try{return ccall("webperl_eval_perl","string",["string"],[e])}catch(e){if(!(e instanceof ExitStatus))throw e;Perl.end()}},Perl.end=function(){if("Running"!=Perl.state){if("Ended"==Perl.state)return void console.debug("Perl: end called when already Ended");throw"Perl: can't call end in state "+Perl.state}var t;try{0!=(t=ccall("emperl_end_perl","number",[],[]))&&console.warn("emperl_end_perl returned with status",t),Module.onExit(t)}catch(e){if(!(e instanceof ExitStatus))throw e;console.debug("Perl: end: ",e),t=e.status,Module.onExit(e.status)}return t},Perl.next_glue_id=0,Perl.GlueTable={},Perl._glue_free_ids={},Perl.glue=function(e){var t,n=Object.keys(Perl._glue_free_ids);if(0<n.length)t=n[0],delete Perl._glue_free_ids[t],Perl.trace&&console.debug("Perl: Glue reused id",t,"to",e);else{if(Perl.next_glue_id>=Number.MAX_SAFE_INTEGER)throw"Perl.GlueTable is overflowing!";t=""+Perl.next_glue_id++,Perl.trace&&console.debug("Perl: Glue id",t,"to",e)}return Perl.GlueTable[t]=e,t},Perl.unglue=function(e){Perl.trace&&console.debug("Perl: Unglue id",e,"from",Perl.GlueTable[e]),delete Perl.GlueTable[e],Perl._glue_free_ids[e]=1};