const doesFileExist=require("./doesFileExist.js"),Database={updateState:function(s,o,i){return new Promise(async(e,t)=>{localStorage.setItem("module",o),localStorage.setItem("position",i);var a=(await Database.getModuleData(s,o,i)).data;let n=await Database.getActions();if(null==n[s]&&(n[s]=[]),null==n[s][o]&&(n[s][o]=[]),null==n[s][o][i]){n[s][o][i]={points:a.points||0,coins:a.coins||0},await Database.setActions(n);let e=await Database.getScore();e.points+=a.points||0,e.coins+=a.coins||0,await Database.setScore(e)}e()})},getActions:function(){return new Promise(async(t,e)=>{let a={};null==localStorage.getItem("actions")&&await Database.setActions(a);try{t(a=JSON.parse(localStorage.getItem("actions")))}catch(e){await Database.setActions({}),t({})}})},setActions:function(a){return new Promise(async(e,t)=>{localStorage.setItem("actions",JSON.stringify(a)),e(!0)})},getAnsweredInlineMC:function(){return new Promise(async(t,e)=>{let a={};null==localStorage.getItem("answeredmc")&&await Database.setAnsweredInlineMC(a);try{t(a=JSON.parse(localStorage.getItem("answeredmc")))}catch(e){await Database.setAnsweredInlineMC({}),t({})}})},setAnsweredInlineMC:function(a){return new Promise(async(e,t)=>{localStorage.setItem("answeredmc",JSON.stringify(a)),e(!0)})},updateMCPoints:function(n,s,o,i,r,l){return new Promise(async(e,t)=>{let a=await Database.getAnsweredInlineMC();if(null==a[n]&&(a[n]={}),null==a[n][s]&&(a[n][s]={}),null==a[n][s][o]&&(a[n][s][o]={}),null==a[n][s][o][i]){a[n][s][o][i]=!0,await Database.setAnsweredInlineMC(a);let e=await Database.getScore();e.points+=r||0,e.coins+=l||0,await Database.setScore(e)}e()})},getScore:function(){return new Promise(async(e,t)=>{let a={points:0,coins:0};null==localStorage.getItem("score")&&await Database.setScore(a);try{a=JSON.parse(localStorage.getItem("score"))}catch(e){await Database.setScore(a)}e(a)})},setScore:function(a){return new Promise(async(e,t)=>{localStorage.setItem("score",JSON.stringify(a)),e(!0)})},getModuleData:function(s,o,i){return new Promise(async(t,a)=>{let e=await tApp.get(`./data/modules/${s}/${o}.json`).catch(e=>{a(e)}),n=await e.json().catch(e=>{a(e)});i<n.pages.length-1?t({data:n.pages[i],type:n.type,moduleLength:n.pages.length,next:{hasNext:!0,module:o,position:i+1},moduleData:n}):tApp.get(`./data/modules/${s}/${o+1}.json`).then(()=>{t({data:n.pages[i],type:n.type,moduleLength:n.pages.length,next:{hasNext:!0,module:o+1,position:0},moduleData:n})}).catch(e=>{t({data:n.pages[i],type:n.type,moduleLength:n.pages.length,next:{hasNext:!1},moduleData:n})})})},getModulePosition:function(n,s){return new Promise(async(e,t)=>{var a=await Database.getActions();null==a[n]||null==a[n][s]?e(0):e(a[n][s].length)})},getModuleCount:function(n){return new Promise(async(e,t)=>{let a=0;for(;await doesFileExist(`/data/modules/${n}/${a}.json`);)a++;e(a)})},getCode:function(a){return new Promise(async(e,t)=>{e(localStorage.getItem("code::"+a))})},setCode:function(a,n){return new Promise(async(e,t)=>{localStorage.setItem("code::"+a,n),e(!0)})},removeCode:function(a){return new Promise(async(e,t)=>{localStorage.removeItem("code::"+a),e(!0)})},getSnippetIds:function(){return new Promise(async(t,e)=>{let a=[];null==localStorage.getItem("snippet_ids")&&await Database.setSnippetIds(a);try{t(a=JSON.parse(localStorage.getItem("snippet_ids")))}catch(e){await Database.setSnippetIds([]),t([])}})},setSnippetIds:function(a){return new Promise(async(e,t)=>{localStorage.setItem("snippet_ids",JSON.stringify(a)),e(!0)})},getSnippet:function(a){return new Promise(async(t,e)=>{try{t(JSON.parse(localStorage.getItem("snippet::"+a)))}catch(e){t(null)}})},setSnippet:function(a){return new Promise(async(e,t)=>{localStorage.setItem("snippet::"+a.id,JSON.stringify(a)),e(!0)})},storeSnippet:function(n){return new Promise(async(e,t)=>{let a=await Database.getSnippetIds();a.findIndex(e=>e==n.id)<0&&(a.push(n.id),await Database.setSnippetIds(a),await Database.setSnippet(n)),e(!0)})},removeSnippet:function(n){return new Promise(async(e,t)=>{localStorage.removeItem("snippet::"+n);let a=await Database.getSnippetIds();0<=a.findIndex(e=>e==n)&&(a.splice(a.findIndex(e=>e==n),1),await Database.setSnippetIds(a)),e(!0)})},getAllSnippets:function(){return new Promise(async(e,t)=>{var a=await Database.getSnippetIds();let n=[];for(let e=0;e<a.length;e++){var s=await Database.getSnippet(a[e]);null!=s&&n.push(s)}e(n)})},clearBasicData:function(){return new Promise(async(e,t)=>{localStorage.removeItem("module"),localStorage.removeItem("position"),localStorage.removeItem("score"),localStorage.removeItem("actions"),e(!0)})},clearAllCode:function(){return new Promise(async(e,t)=>{var a=Object.keys(localStorage).filter(e=>e.startsWith("code::")).map(e=>e.substring(6));for(let e=0;e<a.length;e++)await Database.removeCode(a[e]);e(!0)})},clearAllSnippets:function(){return new Promise(async(e,t)=>{var a=Object.keys(localStorage).filter(e=>e.startsWith("snippet::")).map(e=>e.substring(9));for(let e=0;e<a.length;e++)await Database.removeSnippet(a[e]);localStorage.removeItem("snippet_ids"),e(!0)})},clearAll:function(){return new Promise(async(e,t)=>{await Database.clearBasicData(),await Database.clearAllCode(),await Database.clearAllSnippets(),e(!0)})}};module.exports=Database;