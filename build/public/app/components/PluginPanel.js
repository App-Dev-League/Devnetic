const codeEditorHelper=require("../utils/codeEditor.js"),plugins=require("../utils/plugins.js");class PluginPanel extends tApp.Component{constructor(e,t){for(var i in super(e,t),this.state.pluginSizes={},this.state.plugins=plugins.availablePlugins(),this.state.plugins)this.state.plugins[i].installed=!1;var l=this;!async function(){for(var e in plugins.availablePlugins()){e=plugins.availablePlugins()[e];l.state.pluginSizes[e.id]=await plugins.getDownloadSize(e.id)}l.setState("pluginSizes",l.state.pluginSizes)}(),plugins.getOldPlugins().then(e=>{e.forEach(e=>{codeEditorHelper.showAlertModal(`The plugin ${e.name} has a newer version! This may result in parts of the editor not working. We highly recommend updating as soon as possible. `,[{text:"Ignore",onclick:function(){codeEditorHelper.removeAlertModal(this.parentElement.parentElement.getAttribute("data-editor-alert-modal-index"))}},{text:"Update",onclick:function(){codeEditorHelper.removeAlertModal(this.parentElement.parentElement.getAttribute("data-editor-alert-modal-index")),document.querySelectorAll(".project-module-tabs")[1].children[0].children[3].click(),codeEditorHelper.removeAlertModal(this.parentElement.getAttribute("data-editor-alert-modal-index")),setTimeout(function(){"Uninstall"===document.getElementById("plugin-list-"+e.id).querySelector("h5").innerText&&(document.getElementById("plugin-list-"+e.id).querySelector("h5").click(),setTimeout(function(){document.getElementById("plugin-list-"+e.id).querySelector("h5").click()},1e3))},1e3)}}],"codicon-symbol-property")})})}install(id){var pluginpanel=this;let plugin=document.getElementById("plugin-list-"+id);plugin.querySelector("h5").innerText="Installing...",plugin.querySelector("h5").style.pointerEvents="none",plugin.querySelector(".loading-bar-container").style.opacity=1,plugin.querySelector(".loading-bar").style.width="10%",plugins.download(id,async function(e){console.log(e),plugin.querySelector("h5").innerText="Installing...",plugin.querySelector("h5").style.pointerEvents="none",plugin.querySelector(".loading-bar-container").style.opacity=1,plugin.querySelector(".loading-bar").style.width=Math.round(100*e)+"%"},function(status){if("failed"===status)plugin.querySelector(".loading-bar-container").style.opacity=0,pluginpanel.setState("update","update");else{plugin.querySelector(".loading-bar-container").style.opacity=0,pluginpanel.setState("update","update");let x=plugins.availablePlugins().find(e=>e.id==id);x.onInstall&&eval(x.onInstall)}})}uninstall(e){var t=this;let i=document.getElementById("plugin-list-"+e);i.querySelector(".loading-bar-container").style.opacity=1,i.querySelector(".loading-bar").style.width="10%",plugins.remove(e),i.querySelector(".loading-bar").style.width="100%",setTimeout(function(){i.querySelector(".loading-bar-container").style.opacity=0,t.setState("update","update")},500)}render(e){var l=this;return async function(){let t=[];for(var i in plugins.availablePlugins()){let e=plugins.availablePlugins()[i];e.installed=await plugins.checkPluginStatus(e.id),t.push(e)}JSON.stringify(l.state.plugins)!==JSON.stringify(t)&&l.setState("plugins",t)}(),`<div>
        ${this.state.plugins.map(e=>`<div id="plugin-list-${e.id}" style="margin-bottom: 20px" class="plugin-itm">
                    <img src="${e.image}" style="width: 60px; display: inline-block"/>
                    <div style="display: inline-block; margin-left: 20px; vertical-align: top; width: 80%">
                        <div>
                            <h3 style="margin-bottom: 0; margin-top: 0; display: inline-block; font-weight: 500;">${e.name}</h3>
                            ${e.installed?`<h5 style="display: inline-block; margin: 0; margin-left: 30px; transform: translateY(-2px); font-size: 0.8em; padding: 0 5px; line-height: 14px; background-color: #b12c2c; cursor: pointer" onclick="{{_this}}.uninstall('${e.id}')">Uninstall</h5>`:`<h5 style="display: inline-block; margin: 0; margin-left: 30px; transform: translateY(-2px); font-size: 0.8em; padding: 0 5px; line-height: 14px; background-color: #2BA143; cursor: pointer" onclick="{{_this}}.install('${e.id}')">Install</h5>`}
                            <h6 style="display: inline-block; margin: 0; margin-left: 20px">${Math.round(this.state.pluginSizes[e.id]/1e3)} KB</h6>
                        </div>
                        <p style="margin-top: 0; margin-bottom: 0">${e.description}</p>
                        <div class="loading-bar-container" style="margin-top: 5px; opacity: 0">
                            <div class="loading-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>`).join("")}
        </div>`}}module.exports=PluginPanel;