const ModuleComponent=require("./ModuleComponent.js"),codeTemplateToCode=require("../utils/codeTemplateToCode.js"),Editor=require("./Editor.js"),SnippetsPanel=require("./SnippetsPanel.js"),Instructions=require("./Instructions.js"),CodePreview=require("./CodePreview.js"),TabbedView=require("./TabbedView.js"),PluginPanel=require("./PluginPanel.js"),codeEditorHelper=require("../utils/codeEditor.js");window.codeEditorHelper=codeEditorHelper;class CodeEditor extends ModuleComponent{constructor(e,t){super(e,t),null==this.state.editor&&(this.state.editor=new Editor({},this)),null==this.state.snippetsPanel&&(this.state.snippetsPanel=new SnippetsPanel({},this)),null==this.state.instructions&&(this.state.instructions=new Instructions({},this)),null==this.state.codePreview&&(this.state.codePreview=new CodePreview({},this)),null==this.state.pluginPanel&&(this.state.pluginPanel=new PluginPanel({},this)),null==this.state.tabbedView&&(window.MacGap?this.state.tabbedView=new TabbedView({tabs:[{name:"Instructions",component:this.state.instructions,tabDataset:{tabname:"instructions"}},{name:"Preview",component:this.state.codePreview,tabDataset:{tabname:"preview"}},{name:"Snippets",component:this.state.snippetsPanel,tabDataset:{tabname:"snippets"}}],forceReRender:!0},this):this.state.tabbedView=new TabbedView({tabs:[{name:"Instructions",component:this.state.instructions,tabDataset:{tabname:"instructions"}},{name:"Preview",component:this.state.codePreview,tabDataset:{tabname:"preview"}},{name:"Snippets",component:this.state.snippetsPanel,tabDataset:{tabname:"snippets"}},{name:"Plugins",component:this.state.pluginPanel,tabDataset:{tabname:"plugins"}}],forceReRender:!0},this))}async checknext(){if(0===this.data().validation.length)return this.parent.next();function g(t){return new Promise(e=>setTimeout(e,t))}let b=this;var e,y=!1;try{e=await async function(){function r(r,t){return new Promise((o,e)=>{let n=0;t=t||document.querySelector(".console-wrapper"),window.newLogListener=function(e,t){++n===r&&o(!0)}})}function e(a,o,s){return new Promise((r,e)=>{let i=0;o=o||document.querySelector(".console-wrapper");const t=new MutationObserver(function(e,t){let o=!1;for(var n of e)"childList"===n.type&&(o=!0);!0===o&&i++,!0===s&&console.log("Current sofar: "+i),i===a&&(r(!0),t.disconnect())});t.observe(o,{childList:!0,subtree:!0})})}function a(e,o){return e.forEach(e=>{var t;"lowerCase"===e?o=o.toLowerCase():"trim"===e?o=o.toString().trim():"parseFloat"===e?o=parseFloat(o):"parseInt"===e?o=parseInt(o):"number"===e?o=Number(o):"extract_numbers"===e?o=o.toString().match(/\d+/g)[0]:"remove_spaces"===e?o=o.replaceAll(" ",""):"typeof"===e?o=typeof o:"remove-tabs"===e?o=o.replaceAll("\t",""):"remove-newlines"===e?o=o.replace(/(\r\n|\n|\r)/gm,""):"convert-to-double-quotes"===e?o=o.replaceAll("'",'"'):e.startsWith("includes")?o=o.includes(e.slice("includes ".length)):"toString"===e?o=o.toString():e.startsWith("match")?(t=new RegExp(e.slice("match ".length)),o=o.toString().match(t,"g")||[]):"length"===e&&o&&(o=o.length)}),o}function t(t,o){let n=!0;for(var r in o){var i,r=o[r];let e=t;r.filters&&(e=a(r.filters,t)),"regex"===r.type?(i=new RegExp(r.value),(e.toString().match(i,"g")||[]).length<1&&(n=!1)):"includes"===r.type?e.toString().includes(r.value)||(n=!1):"startsWith"===r.type?e.toString().startsWith(r.value)||(n=!1):"endsWith"!==r.type||e.toString().endsWith(r.value)||(n=!1)}return n}window.newLogCallback=function(e){window.logQueue||(window.logQueue=[]),logQueue.push(e)},async function(){for(;await g(100),!y;){var e;window.logQueue&&0<window.logQueue.length&&(e=window.logQueue.shift(),window.newLogListener?window.newLogListener(e):"The log was Launching tester..."!==e&&"Starting python emulator..."!==e&&window.logQueue.unshift(e))}}();var o=b.data();let i=0;var n,s={};for(n in o.validation){s={},i=0;var l=o.validation[n];if(!0===l.validate){if("validate-output"===l.type){document.body.classList.add("tester-testing");var d,c=["Testing your code against test cases to make sure your code meets the requirements...","Making sure your code meets all the requirements...","Checking whether or not your code does what it's supposed to do...","Making sure your code is working as intended...","Comparing your code's output to the expected output..."];for(d in document.body.setAttribute("data-before",c[Math.floor(Math.random()*c.length)]),await g(1),l.actions){let o=l.actions[d],n=(o.onerror&&(o.onerror=tApp.escape(o.onerror)),o.runwhen);if(void 0!==o.run){document.querySelectorAll(".project-module-tabs")[0].children[0].querySelector(`[data-storage_id='${o.run}']`).click(),await g(100),document.querySelectorAll(".project-module-tabs")[1].children[0].querySelector("[data-tabname='preview']").click(),document.getElementById("console-bridge").click(),window.newLogCallback&&window.newLogCallback(["Launching tester..."]),document.getElementById("code-editor-run-btn").click(),await e(1,document.querySelectorAll(".selected-tab")[1]),await e(1,document.getElementById("preview-container"));for(let e=0;e<1e3&&(await g(100),!document.querySelector(".console-wrapper"));e++);console.log("waiting for console wrapper changes")}else if(void 0!==o.input){n.startsWith("in")&&n.endsWith("outputs")&&(n=parseInt(n.replace("in","").replace("outputs","")),i+=n,await r(n)),o.input=tApp.compileTemplate(o.input,{tester:{variables:s}}),o.input=o.input.replaceAll(/{{(.*?)}}/g,function(e){let t=new Function("tester","return "+e.slice(2,-2));return t({variables:s})}).replaceAll("{{","").replaceAll("}}",""),await function(o){return new Promise(async(t,e)=>{for(let e=0;e<1e3;e++)if(await g(10),document.querySelector(".console-input")){document.querySelector(".console-input").value=o,t(!0);break}e("Could not set input")})}(o.input);var u=new KeyboardEvent("keyup",{bubbles:!0,cancelable:!0,keyCode:13});document.querySelector(".console-input").dispatchEvent(u)}else if(void 0!==o.expect){n.startsWith("in")&&n.endsWith("outputs")&&(n=parseInt(n.replace("in","").replace("outputs","")),i+=n,await r(n,void 0)),o.add||(o.add=1);let e=window.consoleLogs[i+o.add];if(o.reject){if(o.matches)return!t(e,o.matches);if((e=a(o.reject.filters,e))!==o.reject.expect)return window.consoleLogs.push(["Tester returned following problems: "+o.onerror.replaceAll("{{output}}",e)]),document.getElementById("console-bridge").click(),window.newLogCallback&&window.newLogCallback(["Tester returned following problems: "+o.onerror.replaceAll("{{output}}",e)]),!1}else{if(o.matches)return t(e,o.matches);if((e=o.filters?a(o.filters,e):e)!==o.expect)return window.consoleLogs.push(["Tester returned following problems: "+o.onerror.replaceAll("{{output}}",e)]),document.getElementById("console-bridge").click(),window.newLogCallback&&window.newLogCallback(["Tester returned following problems: "+o.onerror.replaceAll("{{output}}",e)]),!1}}else if(void 0!==o.setVar){n.startsWith("in")&&n.endsWith("outputs")&&await r(n=parseInt(n.replace("in","").replace("outputs",""))),o.add||(o.add=1);let e=window.consoleLogs[i+o.add];o.filters&&(e=a(o.filters,e)),s[o.setVar]=e}else if(void 0!==o.exec){n.startsWith("in")&&n.endsWith("outputs")&&(n=parseInt(n.replace("in","").replace("outputs","")),i+=n,await r(n));u=document.getElementById("python-execution-thread").contentWindow.document.querySelector("script").innerHTML;let e=document.getElementById("python-execution-thread").contentWindow.document.querySelector("script"),t=(u+="\n"+o.exec,e.parentElement.removeChild(e),document.getElementById("python-execution-thread").contentWindow.document.createElement("script"));t.innerHTML=u,await g(100),document.getElementById("python-execution-thread").contentWindow.document.body.appendChild(t)}}document.body.classList.remove("tester-testing")}else if("validate-code"===l.type)for(var p in l.correct){document.querySelectorAll(".project-module-tabs")[0].children[0].querySelector(`[data-storage_id='${l.fileStorageId}']`).click(),document.querySelectorAll(".project-module-tabs")[1].children[0].querySelector("[data-tabname='preview']").click(),await g(500);let e=l.correct[p];if(e.value!==a(e.apply,codeEditorHelper.getValue()))return e.onerror&&(e.onerror=tApp.escape(e.onerror),codeEditorHelper.showAlertModal(e.onerror,[{text:"Ok",onclick:function(){codeEditorHelper.removeAlertModal(this.parentElement.parentElement.getAttribute("data-editor-alert-modal-index"))}}],"codicon-error")),!1}else if("validate-dom"===l.type){document.body.classList.add("tester-testing");var m,c=["Testing your code against test cases to make sure your code meets the requirements...","Making sure your code meets all the requirements...","Checking whether or not your code does what it's supposed to do...","Making sure your code is working as intended...","Comparing your code's output to the expected output..."];for(m in document.body.setAttribute("data-before",c[Math.floor(Math.random()*c.length)]),await g(1),l.actions){let t=l.actions[m];if(void 0!==t.run){if(document.querySelectorAll(".project-module-tabs")[0].children[0].querySelector(`[data-storage_id='${t.run}']`).click(),await g(100),document.querySelectorAll(".project-module-tabs")[1].children[0].querySelector("[data-tabname='preview']").click(),await g(1e3),document.getElementById("code-editor-run-btn").click(),t.run.endsWith("jsx"))for(let e=0;e<1e3&&(await g(100),20===e&&document.getElementById("code-editor-run-btn").click(),!document.querySelector("#preview")||!document.querySelector("#preview").contentWindow.document.body.innerHTML.trim().startsWith('<div id="root"'));e++);await g(1e3)}else if(void 0!==t.execOnDOM){const h=Object.getPrototypeOf(async function(){}).constructor;var w=document.getElementById("preview").contentWindow;let e=new h("window","document",t.execOnDOM);await e(w,w.document),await g(150)}else if(void 0!==t.checkDOM&&(document.getElementById("preview").contentWindow,new Function([],"var dom = document.getElementById('preview').contentWindow; return dom."+t.command)()!==t.checkDOM))return t.onerror&&(t.onerror=tApp.escape(t.onerror),codeEditorHelper.showAlertModal("The tester encountered the following problems with your code: "+t.onerror.replaceAll("{{output}}"),[{text:"Ok",onclick:function(){codeEditorHelper.removeAlertModal(this.parentElement.parentElement.getAttribute("data-editor-alert-modal-index"))}}])),!1}document.body.classList.remove("tester-testing")}document.body.classList.remove("tester-testing")}}return!0}()}catch(e){return document.body.classList.remove("tester-testing"),y=!0,console.log("An error was encountered while validating code",e),window.consoleLogs.push(["A server error occured while validating your code! This most likely means that something is wrong with your code. Try reloading the page"]),document.getElementById("console-bridge").click(),void(window.newLogCallback&&window.newLogCallback(["A server error occured while validating your code! This most likely means that something is wrong with your code. Try reloading the page"]))}document.body.classList.remove("tester-testing"),y=!0,console.log("test results",e),!1===e?codeEditorHelper.showAlertModal("Test cases failed :( try re-writing your code.",[{text:"Ok",onclick:function(){codeEditorHelper.removeAlertModal(this.parentElement.parentElement.getAttribute("data-editor-alert-modal-index"))}}],"codicon-error"):codeEditorHelper.showAlertModal("Congratulations! Your code passed the requirements! Your code will be saved, so feel free to come back and continue working!",[{text:"Move on",onclick:function(){b.parent.next(),codeEditorHelper.removeAlertModal(this.parentElement.parentElement.getAttribute("data-editor-alert-modal-index"))}},{text:"Keep coding",onclick:function(){codeEditorHelper.removeAlertModal(this.parentElement.parentElement.getAttribute("data-editor-alert-modal-index"))}}],"codicon-pass")}render(e){return null!=this.data()?(document.getElementById("code-editor-tab")&&(delete window.monacoAlreadyLoaded,delete window.addedEditorEventListeners,tApp.getComponentFromDOM(document.getElementById("code-editor-tab")).parent.setState("rerender",Date.now())),this.state.instructions.state.elements=this.data().elements,this.state.instructions.state.hints=this.data().hints,this.state.instructions.state.nextText=0<this.data().validation.length?"Validate code & move on":"Move on",`<div id="code-editor-component">
						${this.state.editor}
						<div class="vertical-divider"></div>
						${this.state.tabbedView}
					</div>`):"<div></div>"}}module.exports=CodeEditor;