const windows = require("./utils/window.js")


window.pyscriptw = {
    start: function (code, dependencies) {
        if (!dependencies) dependencies = {}
        document.getElementById("console-bridge").dispatchEvent(new Event('change'));
        window.consoleLogs = []
        let prevIframe = document.querySelector("#python-execution-thread");
        if (prevIframe) prevIframe.parentElement.removeChild(prevIframe);
        logToConsole("Starting python execution thread...");
        let iframe = document.createElement("iframe")
        iframe.style.width = 0
        iframe.style.height = 0
        iframe.id = "python-execution-thread"
        iframe.src = "./assets/plugins/brython/iframe.html"
        document.body.appendChild(iframe);
        var pythonWindowId = null
        iframe.onload = async function () {
            iframe.contentWindow.pythonCode = `
def slpeumcnasdiekasdfke(x=0):
    raise Exception("time.sleep() is not implemented! Please use await asyncio.sleep() instead!")
time.sleep = slpeumcnasdiekasdfke\n`+code;
            iframe.contentWindow.pythonDependencies = dependencies;
            iframe.contentWindow.showImage = function (innerHTML) {
                if (!pythonWindowId) pythonWindowId = windows.newWindow("Python Window", innerHTML);
                else windows.updateWindow(pythonWindowId, innerHTML)
                console.log(pythonWindowId)
            }
            iframe.contentWindow.logFunction = function () {
                var log = arguments;
                let arrLog = []
                for (let i in log) {
                    if (log[i].toString().startsWith("JsException")) continue;
                    arrLog.push(log[i])
                }
                window.consoleLogs.push(arrLog)
                window.document.getElementById("console-bridge").click()
                if (window.newLogCallback) window.newLogCallback(log)
            }
            iframe.contentWindow.console.error = iframe.contentWindow.console.log

            iframe.contentWindow.onerror = function (err) {
                err = err.toString()
                window.consoleLogs.push([err])
                window.document.getElementById("console-bridge").click()
                return false;
            }
            iframe.contentWindow.postMessage("start")
        }
    }
}
function logToConsole(text) {
    window.consoleLogs.push([text])
    document.getElementById("console-bridge").click()
}