const ModuleComponent=require("./ModuleComponent.js"),codeTemplateToCode=require("../utils/codeTemplateToCode.js"),Editor=require("./Editor.js"),SnippetsPanel=require("./SnippetsPanel.js"),Instructions=require("./Instructions.js"),CodePreview=require("./CodePreview.js"),TabbedView=require("./TabbedView.js"),PluginPanel=require("./PluginPanel.js"),codeEditorHelper=require("../utils/codeEditor.js");window.codeEditorHelper=codeEditorHelper;class CodeEditor extends ModuleComponent{constructor(e,t){super(e,t),null==this.state.editor&&(this.state.editor=new Editor({},this)),null==this.state.snippetsPanel&&(this.state.snippetsPanel=new SnippetsPanel({},this)),null==this.state.instructions&&(this.state.instructions=new Instructions({},this)),null==this.state.codePreview&&(this.state.codePreview=new CodePreview({},this)),null==this.state.pluginPanel&&(this.state.pluginPanel=new PluginPanel({},this)),null==this.state.tabbedView&&(this.state.tabbedView=new TabbedView({tabs:[{name:"Instructions",component:this.state.instructions,tabDataset:{tabname:"instructions"}},{name:"Preview",component:this.state.codePreview,tabDataset:{tabname:"preview"}},{name:"Snippets",component:this.state.snippetsPanel,tabDataset:{tabname:"snippets"}},{name:"Plugins",component:this.state.pluginPanel,tabDataset:{tabname:"plugins"}}],forceReRender:!0},this))}async checknext(){if(0===this.data().validation.length)return this.parent.next();function sleep(t){return new Promise(e=>setTimeout(e,t))}let parentThis=this;var stopManagingQueue=!1,results;async function main(){async function manageLogQueue(){for(;await sleep(100),!stopManagingQueue;){var e;window.logQueue&&0<window.logQueue.length&&(e=window.logQueue.shift(),window.newLogListener?window.newLogListener(e):"The log was Launching tester..."!==e&&"Starting python emulator..."!==e&&window.logQueue.unshift(e))}}function waitForXInputs(r,t,e){return new Promise((n,e)=>{let o=0;t=t||document.querySelector(".console-wrapper"),window.newLogListener=function(e,t){++o===r&&n(!0)}})}function waitForChildChanges(a,n,s){return new Promise((r,e)=>{let i=0;n=n||document.querySelector(".console-wrapper");const t=new MutationObserver(function(e,t){let n=!1;for(var o of e)"childList"===o.type&&(n=!0);!0===n&&i++,!0===s&&console.log("Current sofar: "+i),i===a&&(r(!0),t.disconnect())});t.observe(n,{childList:!0,subtree:!0})})}function applyFilters(e,n){return e.forEach(e=>{var t;"lowerCase"===e?n=n.toLowerCase():"trim"===e?n=n.toString().trim():"parseFloat"===e?n=parseFloat(n):"parseInt"===e?n=parseInt(n):"number"===e?n=Number(n):"extract_numbers"===e?n=n.toString().match(/\d+/g)[0]:"remove_spaces"===e?n=n.replaceAll(" ",""):"typeof"===e?n=typeof n:"remove-tabs"===e?n=n.replaceAll("\t",""):"remove-newlines"===e?n=n.replace(/(\r\n|\n|\r)/gm,""):"convert-to-double-quotes"===e?n=n.replaceAll("'",'"'):e.startsWith("includes")?n=n.includes(e.slice("includes ".length)):"toString"===e?n=n.toString():e.startsWith("match")?(t=new RegExp(e.slice("match ".length)),n=n.toString().match(t,"g")||[]):"length"===e&&n&&(n=n.length)}),n}function setInput(n){return new Promise(async(t,e)=>{for(let e=0;e<1e3;e++)if(await sleep(10),document.querySelector(".console-input")){document.querySelector(".console-input").value=n,t(!0);break}e("Could not set input")})}function testMatches(t,n){let o=!0;for(var r in n){var i,r=n[r];let e=t;r.filters&&(e=applyFilters(r.filters,t)),"regex"===r.type?(i=new RegExp(r.value),(e.toString().match(i,"g")||[]).length<1&&(o=!1)):"includes"===r.type?e.toString().includes(r.value)||(o=!1):"startsWith"===r.type?e.toString().startsWith(r.value)||(o=!1):"endsWith"!==r.type||e.toString().endsWith(r.value)||(o=!1)}return o}window.newLogCallback=function(e){window.logQueue||(window.logQueue=[]),logQueue.push(e)},manageLogQueue();let data=parentThis.data(),logIndex=0;var testVars={},i;for(i in data.validation){testVars={},logIndex=0;let tester=data.validation[i];if(!0===tester.validate){if("validate-output"===tester.type){document.body.classList.add("tester-testing");let testingMessages=["Testing your code against test cases to make sure your code meets the requirements...","Making sure your code meets all the requirements...","Checking whether or not your code does what it's supposed to do...","Making sure your code is working as intended...","Comparing your code's output to the expected output..."];for(var p in document.body.setAttribute("data-before",testingMessages[Math.floor(Math.random()*testingMessages.length)]),await sleep(1),tester.actions){let action=tester.actions[p],runwhen=(action.onerror&&(action.onerror=tApp.escape(action.onerror)),action.runwhen);if(void 0!==action.run){document.querySelectorAll(".project-module-tabs")[0].children[0].querySelector(`[data-storage_id='${action.run}']`).click(),await sleep(100),document.querySelectorAll(".project-module-tabs")[1].children[0].querySelector("[data-tabname='preview']").click(),document.getElementById("console-bridge").click(),window.newLogCallback&&window.newLogCallback(["Launching tester..."]),document.getElementById("code-editor-run-btn").click(),await waitForChildChanges(1,document.querySelectorAll(".selected-tab")[1]),await waitForChildChanges(1,document.getElementById("preview-container"));for(let i=0;i<1e3&&(await sleep(100),!document.querySelector(".console-wrapper"));i++);console.log("waiting for console wrapper changes")}else if(void 0!==action.input){runwhen.startsWith("in")&&runwhen.endsWith("outputs")&&(runwhen=parseInt(runwhen.replace("in","").replace("outputs","")),logIndex+=runwhen,await waitForXInputs(runwhen)),action.input=tApp.compileTemplate(action.input,{tester:{variables:testVars}}),action.input=action.input.replaceAll(/(?<={{)(.*)(?=}})/g,function(e){let t=new Function("tester","return "+e);return t({variables:testVars})}).replaceAll("{{","").replaceAll("}}",""),await setInput(action.input);let ke=new KeyboardEvent("keyup",{bubbles:!0,cancelable:!0,keyCode:13});document.querySelector(".console-input").dispatchEvent(ke)}else if(void 0!==action.expect){runwhen.startsWith("in")&&runwhen.endsWith("outputs")&&(runwhen=parseInt(runwhen.replace("in","").replace("outputs","")),logIndex+=runwhen,await waitForXInputs(runwhen,void 0,!0)),action.add||(action.add=1);let latest=window.consoleLogs[logIndex+action.add];if(action.reject){if(action.matches)return!testMatches(latest,action.matches);if(latest=applyFilters(action.reject.filters,latest),latest!==action.reject.expect)return window.consoleLogs.push(["Tester returned following problems: "+action.onerror.replaceAll("{{output}}",latest)]),document.getElementById("console-bridge").click(),window.newLogCallback&&window.newLogCallback(["Tester returned following problems: "+action.onerror.replaceAll("{{output}}",latest)]),!1}else{if(action.matches)return testMatches(latest,action.matches);if(action.filters&&(latest=applyFilters(action.filters,latest)),latest!==action.expect)return window.consoleLogs.push(["Tester returned following problems: "+action.onerror.replaceAll("{{output}}",latest)]),document.getElementById("console-bridge").click(),window.newLogCallback&&window.newLogCallback(["Tester returned following problems: "+action.onerror.replaceAll("{{output}}",latest)]),!1}}else if(void 0!==action.setVar){runwhen.startsWith("in")&&runwhen.endsWith("outputs")&&(runwhen=parseInt(runwhen.replace("in","").replace("outputs","")),await waitForXInputs(runwhen)),action.add||(action.add=1);let latest=window.consoleLogs[logIndex+action.add];action.filters&&(latest=applyFilters(action.filters,latest)),testVars[action.setVar]=latest}else if(void 0!==action.exec){runwhen.startsWith("in")&&runwhen.endsWith("outputs")&&(runwhen=parseInt(runwhen.replace("in","").replace("outputs","")),logIndex+=runwhen,await waitForXInputs(runwhen));let currentScript=document.getElementById("python-execution-thread").contentWindow.document.querySelector("script").innerHTML,scriptTag=document.getElementById("python-execution-thread").contentWindow.document.querySelector("script"),newScriptTag=(currentScript+="\n"+action.exec,scriptTag.parentElement.removeChild(scriptTag),document.getElementById("python-execution-thread").contentWindow.document.createElement("script"));newScriptTag.innerHTML=currentScript,await sleep(100),document.getElementById("python-execution-thread").contentWindow.document.body.appendChild(newScriptTag)}}document.body.classList.remove("tester-testing")}else if("validate-code"===tester.type)for(let p in tester.correct){document.querySelectorAll(".project-module-tabs")[0].children[0].querySelector(`[data-storage_id='${tester.fileStorageId}']`).click(),document.querySelectorAll(".project-module-tabs")[1].children[0].querySelector("[data-tabname='preview']").click(),await sleep(500);let element=tester.correct[p],expected=element.value,actual=applyFilters(element.apply,codeEditorHelper.getValue());if(expected!==actual)return element.onerror&&(element.onerror=tApp.escape(element.onerror),codeEditorHelper.showAlertModal(element.onerror,[{text:"Ok",onclick:function(){codeEditorHelper.removeAlertModal(this.parentElement.parentElement.getAttribute("data-editor-alert-modal-index"))}}],"codicon-error")),!1}else if("validate-dom"===tester.type){document.body.classList.add("tester-testing");let testingMessages=["Testing your code against test cases to make sure your code meets the requirements...","Making sure your code meets all the requirements...","Checking whether or not your code does what it's supposed to do...","Making sure your code is working as intended...","Comparing your code's output to the expected output..."];document.body.setAttribute("data-before",testingMessages[Math.floor(Math.random()*testingMessages.length)]),await sleep(1);for(let p in tester.actions){let action=tester.actions[p];if(void 0!==action.run){if(document.querySelectorAll(".project-module-tabs")[0].children[0].querySelector(`[data-storage_id='${action.run}']`).click(),await sleep(100),document.querySelectorAll(".project-module-tabs")[1].children[0].querySelector("[data-tabname='preview']").click(),await sleep(1e3),document.getElementById("code-editor-run-btn").click(),action.run.endsWith("jsx"))for(let i=0;i<1e3&&(await sleep(100),20===i&&document.getElementById("code-editor-run-btn").click(),!document.querySelector("#preview")||!document.querySelector("#preview").contentWindow.document.body.innerHTML.trim().startsWith('<div id="root"'));i++);await sleep(1e3)}else if(void 0!==action.execOnDOM){let dom=document.getElementById("preview").contentWindow;eval("dom."+action.execOnDOM)}else if(void 0!==action.checkDOM){let dom=document.getElementById("preview").contentWindow,result=new Function([],"var dom = document.getElementById('preview').contentWindow; return dom."+action.command)();if(result!==action.checkDOM)return action.onerror&&(action.onerror=tApp.escape(action.onerror),codeEditorHelper.showAlertModal("The tester encountered the following problems with your code: "+action.onerror.replaceAll("{{output}}"),[{text:"Ok",onclick:function(){codeEditorHelper.removeAlertModal(this.parentElement.parentElement.getAttribute("data-editor-alert-modal-index"))}}])),!1}}document.body.classList.remove("tester-testing")}document.body.classList.remove("tester-testing")}}return!0}try{results=await main()}catch(err){return document.body.classList.remove("tester-testing"),stopManagingQueue=!0,console.log("An error was encountered while validating code",err),window.consoleLogs.push(["A server error occured while validating your code! This most likely means that something is wrong with your code. Try reloading the page"]),document.getElementById("console-bridge").click(),void(window.newLogCallback&&window.newLogCallback(["A server error occured while validating your code! This most likely means that something is wrong with your code. Try reloading the page"]))}document.body.classList.remove("tester-testing"),stopManagingQueue=!0,console.log("test results",results),!1===results?codeEditorHelper.showAlertModal("Test cases failed :( try re-writing your code.",[{text:"Ok",onclick:function(){codeEditorHelper.removeAlertModal(this.parentElement.parentElement.getAttribute("data-editor-alert-modal-index"))}}],"codicon-error"):codeEditorHelper.showAlertModal("Congratulations! Your code passed the requirements! Your code will be saved, so feel free to come back and continue working!",[{text:"Move on",onclick:function(){parentThis.parent.next(),codeEditorHelper.removeAlertModal(this.parentElement.parentElement.getAttribute("data-editor-alert-modal-index"))}},{text:"Keep coding",onclick:function(){codeEditorHelper.removeAlertModal(this.parentElement.parentElement.getAttribute("data-editor-alert-modal-index"))}}],"codicon-pass")}render(e){return null!=this.data()?(document.getElementById("code-editor-tab")&&(delete window.monacoAlreadyLoaded,delete window.addedEditorEventListeners,tApp.getComponentFromDOM(document.getElementById("code-editor-tab")).parent.setState("rerender",Date.now())),this.state.instructions.state.elements=this.data().elements,this.state.instructions.state.hints=this.data().hints,this.state.instructions.state.nextText=0<this.data().validation.length?"Validate code & move on":"Move on",`<div id="code-editor-component">
						${this.state.editor}
						<div class="vertical-divider"></div>
						${this.state.tabbedView}
					</div>`):"<div></div>"}}module.exports=CodeEditor;