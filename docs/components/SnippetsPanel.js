const codeTemplateToCode=require("../utils/codeTemplateToCode.js"),codeEditorHelper=require("../utils/codeEditor.js"),codeBlock=require("./codeBlock.js"),DB=require("../utils/Database.js"),compileSnippet=require("../utils/compileSnippet.js"),Input=require("./Input.js");class SnippetsPanel extends tApp.Component{constructor(e,t){super(e,t);var i=this;null==this.state.snippets&&(this.state.snippets=[]),null==this.state.showSnippets&&(this.state.showSnippets=this.state.snippets),null==this.state.input&&(this.state.input=new Input({classList:["short-answer-input"],type:"text",properties:["autofocus",'style="margin-top: 0; margin-bottom: 20px; font-size: 1em; border: 2px solid var(--blue);"','placeholder="Search..."'],onChange:function(){i.showSearch(this.value,!0)}})),async function(){var t;for(t of await DB.getSnippetIds()){let e=await DB.getSnippet(t);e.category||(e.category="Miscellaneous"),i.state.snippets.push(e)}var e=i.state.snippets,s="category",e=e.reduce(function(e,t){return(e[t[s]]=e[t[s]]||[]).push(t),e},{}),n=[];Object.entries(e).forEach(([e,t])=>{n.push({categoryName:e}),n=n.concat(t)}),i.state.snippets=n,i.setState("showSnippets",i.state.snippets)}()}showModal(t){let e=this.state.snippets.find(e=>e.id==t),s=document.getElementById("snippets-modal");(s=s.cloneNode(!0)).removeAttribute("id"),s.dataset.snippetId=t,s.querySelector("h3").innerText=e.name+" Snippet",s.querySelector(".inputs").innerHTML="",e.attributes.forEach(e=>{let t=document.createElement("input");t.className="short-answer-input",t.classList.add("insert-snippet-input"),t.placeholder=e.label,t.id="insert-snippet-input-"+e.id,s.querySelector(".inputs").appendChild(t)}),s.querySelector("span").onclick=function(){s.parentNode.removeChild(s)},s.classList.remove("none"),document.body.appendChild(s)}insertModal(e){let t=e.querySelectorAll(".insert-snippet-input"),s=e.dataset.snippetId;var n=this.state.snippets.find(e=>e.id==s),i=[];t.forEach(e=>{i.push(e.value)}),code=compileSnippet(n,i),document.getElementById("code-frame").contentWindow.codeEditor.trigger("keyboard","type",{text:code.replaceAll("\t","")}),document.getElementById("code-frame").contentWindow.codeEditor.getAction("editor.action.formatDocument").run(),e.parentNode.removeChild(e)}showSearch(s,e){s=s.toLowerCase();let n=[];if(this.state.snippets.forEach(t=>{if(t.categoryName)n.push(t);else{let e=t.name.toLowerCase();e.includes(s)&&n.push(t)}}),!0===e)this.setState("showSnippets",n);else if(document.querySelectorAll(".snippet-block").forEach(e=>{e.classList.add("none")}),this.state.showSnippets.forEach(e=>{document.getElementById("snippet-id-"+e.id).classList.remove("none")}),0===this.state.showSnippets.length){let e=document.getElementById("snippets-panel-no-result"),t=(e&&e.parentNode.removeChild(e),document.createElement("h4"));t.id="snippets-panel-no-result",t.style="display: block; text-align: center",t.innerHTML="We couldn't find any snippets that matched your query :(<br><h6 style='display: block; text-align: center'>You may need to unlock this snippet</h6>",document.getElementById("snippets-panel").appendChild(t)}else{let e=document.getElementById("snippets-panel-no-result");e&&e.parentNode.removeChild(e)}}render(e){return`<div class="snippets-panel" id="snippets-panel">
		${this.state.input}
		${this.state.showSnippets.map(e=>e.categoryName?`<h2 style="margin-top: 20px; margin-bottom: 10px;">${e.categoryName}</h2>`:(e.example=e.example.replaceAll("<","&lt;").replaceAll(">","&gt;"),`<div class="snippet-block" id="snippet-id-${e.id}">
			<span class="snippet-title" style="margin-bottom: 10px; display: block">${e.name}</span>
				<div class="snippet-code pointer snippet-btn" style="margin-bottom: 20px" onclick='{{_this}}.parent.children[1].showModal("${e.id}")'>
					${new codeBlock({code:e.example,language:e.lang})}
				</div>
			</div>
				`)).join(" ")}
		</div>`}}module.exports=SnippetsPanel;